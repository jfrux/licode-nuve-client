var Url=require("url"),spawn=require("child_process").spawn,fs=require("fs"),XMLHttpRequest=function(){var a,b,c=this,d=require("http"),e=require("https"),f={},g={"User-Agent":"node.js",Accept:"*/*"},h=!1,i=!1,j=g;this.UNSENT=0,this.OPENED=1,this.HEADERS_RECEIVED=2,this.LOADING=3,this.DONE=4,this.readyState=this.UNSENT,this.onreadystatechange=null,this.responseText="",this.responseXML="",this.status=null,this.statusText=null,this.open=function(a,b,c,d,e){f={method:a,url:b.toString(),async:"boolean"!=typeof c?!0:c,user:d||null,password:e||null},this.abort(),l(this.OPENED)},this.setRequestHeader=function(a,b){if(this.readyState!=this.OPENED)throw"INVALID_STATE_ERR: setRequestHeader can only be called when state is OPEN";if(h)throw"INVALID_STATE_ERR: send flag is true";j[a]=b},this.getResponseHeader=function(a){return this.readyState>this.OPENED&&b.headers[a]&&!i?b.headers[a]:null},this.getAllResponseHeaders=function(){if(this.readyState<this.HEADERS_RECEIVED||i)return"";var a="";for(var c in b.headers)a+=c+": "+b.headers[c]+"\r\n";return a.substr(0,a.length-2)},this.send=function(g){if(this.readyState!=this.OPENED)throw"INVALID_STATE_ERR: connection must be opened before send() is called";if(h)throw"INVALID_STATE_ERR: send has already been called";var k=!1,m=Url.parse(f.url);switch(m.protocol){case"https:":k=!0;case"http:":var n=m.hostname;break;case void 0:case"":var n="localhost";break;default:throw"Protocol not supported."}var o=m.port||(k?443:80),p=m.pathname+(m.search?m.search:"");if(this.setRequestHeader("Host",n),f.user){"undefined"==typeof f.password&&(f.password="");var q=new Buffer(f.user+":"+f.password);j.Authorization="Basic "+q.toString("base64")}"GET"==f.method||"HEAD"==f.method?g=null:g&&(this.setRequestHeader("Content-Length",Buffer.byteLength(g)),j["Content-Type"]||this.setRequestHeader("Content-Type","text/plain;charset=UTF-8"));var r={host:n,port:o,path:p,method:f.method,headers:j};if(i=!1,!f.hasOwnProperty("async")||f.async){var s=k?e.request:d.request;h=!0,"function"==typeof c.onreadystatechange&&c.onreadystatechange(),a=s(r,function(a){b=a,b.setEncoding("utf8"),l(c.HEADERS_RECEIVED),c.status=b.statusCode,b.on("data",function(a){a&&(c.responseText+=a),h&&l(c.LOADING)}),b.on("end",function(){h&&(l(c.DONE),h=!1)}),b.on("error",function(a){c.handleError(a)})}).on("error",function(a){c.handleError(a)}),g&&a.write(g),a.end()}else{var t=".node-xmlhttprequest-sync-"+process.pid;fs.writeFileSync(t,"","utf8");var u="var http = require('http'), https = require('https'), fs = require('fs');var doRequest = http"+(k?"s":"")+".request;var options = "+JSON.stringify(r)+";var responseText = '';var req = doRequest(options, function(response) {response.setEncoding('utf8');response.on('data', function(chunk) {responseText += chunk;});response.on('end', function() {fs.writeFileSync('"+t+"', 'NODE-XMLHTTPREQUEST-STATUS:' + response.statusCode + ',' + responseText, 'utf8');});response.on('error', function(error) {fs.writeFileSync('"+t+"', 'NODE-XMLHTTPREQUEST-ERROR:' + JSON.stringify(error), 'utf8');});}).on('error', function(error) {fs.writeFileSync('"+t+"', 'NODE-XMLHTTPREQUEST-ERROR:' + JSON.stringify(error), 'utf8');});"+(g?"req.write('"+g.replace(/'/g,"\\'")+"');":"")+"req.end();";for(syncProc=spawn(process.argv[0],["-e",u]);""==(c.responseText=fs.readFileSync(t,"utf8")););if(syncProc.stdin.end(),fs.unlinkSync(t),c.responseText.match(/^NODE-XMLHTTPREQUEST-ERROR:/)){var v=c.responseText.replace(/^NODE-XMLHTTPREQUEST-ERROR:/,"");c.handleError(v)}else c.status=c.responseText.replace(/^NODE-XMLHTTPREQUEST-STATUS:([0-9]*),.*/,"$1"),c.responseText=c.responseText.replace(/^NODE-XMLHTTPREQUEST-STATUS:[0-9]*,(.*)/,"$1"),l(c.DONE)}},this.handleError=function(a){this.status=503,this.statusText=a,this.responseText=a.stack,i=!0,l(this.DONE)},this.abort=function(){a&&(a.abort(),a=null),j=g,this.responseText="",this.responseXML="",i=!0,this.readyState===this.UNSENT||this.readyState===this.OPENED&&!h||this.readyState===this.DONE||(h=!1,l(this.DONE)),this.readyState=this.UNSENT};var k={};this.addEventListener=function(a,b){a in k||(k[a]=[]),k[a].push(b)};var l=function(a){if(c.readyState=a,"function"==typeof c.onreadystatechange&&c.onreadystatechange(),"readystatechange"in k)for(var b=k.readystatechange.length,d=0;b>d;d++)k.readystatechange[d].call(c)}},CryptoJS=CryptoJS||function(a,b){var c={},d=c.lib={},e=d.Base=function(){function a(){}return{extend:function(b){a.prototype=this;var c=new a;return b&&c.mixIn(b),c.$super=this,c},create:function(){var a=this.extend();return a.init.apply(a,arguments),a},init:function(){},mixIn:function(a){for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b]);a.hasOwnProperty("toString")&&(this.toString=a.toString)},clone:function(){return this.$super.extend(this)}}}(),f=d.WordArray=e.extend({init:function(a,c){a=this.words=a||[],this.sigBytes=c!=b?c:4*a.length},toString:function(a){return(a||h).stringify(this)},concat:function(a){var b=this.words,c=a.words,d=this.sigBytes,a=a.sigBytes;if(this.clamp(),d%4)for(var e=0;a>e;e++)b[d+e>>>2]|=(c[e>>>2]>>>24-8*(e%4)&255)<<24-8*((d+e)%4);else if(65535<c.length)for(e=0;a>e;e+=4)b[d+e>>>2]=c[e>>>2];else b.push.apply(b,c);return this.sigBytes+=a,this},clamp:function(){var b=this.words,c=this.sigBytes;b[c>>>2]&=4294967295<<32-8*(c%4),b.length=a.ceil(c/4)},clone:function(){var a=e.clone.call(this);return a.words=this.words.slice(0),a},random:function(b){for(var c=[],d=0;b>d;d+=4)c.push(4294967296*a.random()|0);return f.create(c,b)}}),g=c.enc={},h=g.Hex={stringify:function(a){for(var b=a.words,a=a.sigBytes,c=[],d=0;a>d;d++){var e=b[d>>>2]>>>24-8*(d%4)&255;c.push((e>>>4).toString(16)),c.push((15&e).toString(16))}return c.join("")},parse:function(a){for(var b=a.length,c=[],d=0;b>d;d+=2)c[d>>>3]|=parseInt(a.substr(d,2),16)<<24-4*(d%8);return f.create(c,b/2)}},i=g.Latin1={stringify:function(a){for(var b=a.words,a=a.sigBytes,c=[],d=0;a>d;d++)c.push(String.fromCharCode(b[d>>>2]>>>24-8*(d%4)&255));return c.join("")},parse:function(a){for(var b=a.length,c=[],d=0;b>d;d++)c[d>>>2]|=(255&a.charCodeAt(d))<<24-8*(d%4);return f.create(c,b)}},j=g.Utf8={stringify:function(a){try{return decodeURIComponent(escape(i.stringify(a)))}catch(b){throw Error("Malformed UTF-8 data")}},parse:function(a){return i.parse(unescape(encodeURIComponent(a)))}},k=d.BufferedBlockAlgorithm=e.extend({reset:function(){this._data=f.create(),this._nDataBytes=0},_append:function(a){"string"==typeof a&&(a=j.parse(a)),this._data.concat(a),this._nDataBytes+=a.sigBytes},_process:function(b){var c=this._data,d=c.words,e=c.sigBytes,g=this.blockSize,h=e/(4*g),h=b?a.ceil(h):a.max((0|h)-this._minBufferSize,0),b=h*g,e=a.min(4*b,e);if(b){for(var i=0;b>i;i+=g)this._doProcessBlock(d,i);i=d.splice(0,b),c.sigBytes-=e}return f.create(i,e)},clone:function(){var a=e.clone.call(this);return a._data=this._data.clone(),a},_minBufferSize:0});d.Hasher=k.extend({init:function(){this.reset()},reset:function(){k.reset.call(this),this._doReset()},update:function(a){return this._append(a),this._process(),this},finalize:function(a){return a&&this._append(a),this._doFinalize(),this._hash},clone:function(){var a=k.clone.call(this);return a._hash=this._hash.clone(),a},blockSize:16,_createHelper:function(a){return function(b,c){return a.create(c).finalize(b)}},_createHmacHelper:function(a){return function(b,c){return l.HMAC.create(a,c).finalize(b)}}});var l=c.algo={};return c}(Math);!function(){var a=CryptoJS,b=a.lib,c=b.WordArray,b=b.Hasher,d=[],e=a.algo.SHA1=b.extend({_doReset:function(){this._hash=c.create([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(a,b){for(var c=this._hash.words,e=c[0],f=c[1],g=c[2],h=c[3],i=c[4],j=0;80>j;j++){if(16>j)d[j]=0|a[b+j];else{var k=d[j-3]^d[j-8]^d[j-14]^d[j-16];d[j]=k<<1|k>>>31}k=(e<<5|e>>>27)+i+d[j],k=20>j?k+((f&g|~f&h)+1518500249):40>j?k+((f^g^h)+1859775393):60>j?k+((f&g|f&h|g&h)-1894007588):k+((f^g^h)-899497514),i=h,h=g,g=f<<30|f>>>2,f=e,e=k}c[0]=c[0]+e|0,c[1]=c[1]+f|0,c[2]=c[2]+g|0,c[3]=c[3]+h|0,c[4]=c[4]+i|0},_doFinalize:function(){var a=this._data,b=a.words,c=8*this._nDataBytes,d=8*a.sigBytes;b[d>>>5]|=128<<24-d%32,b[(d+64>>>9<<4)+15]=c,a.sigBytes=4*b.length,this._process()}});a.SHA1=b._createHelper(e),a.HmacSHA1=b._createHmacHelper(e)}(),function(){var a=CryptoJS,b=a.enc.Utf8;a.algo.HMAC=a.lib.Base.extend({init:function(a,c){a=this._hasher=a.create(),"string"==typeof c&&(c=b.parse(c));var d=a.blockSize,e=4*d;c.sigBytes>e&&(c=a.finalize(c));for(var f=this._oKey=c.clone(),g=this._iKey=c.clone(),h=f.words,i=g.words,j=0;d>j;j++)h[j]^=1549556828,i[j]^=909522486;f.sigBytes=g.sigBytes=e,this.reset()},reset:function(){var a=this._hasher;a.reset(),a.update(this._iKey)},update:function(a){return this._hasher.update(a),this},finalize:function(a){var b=this._hasher,a=b.finalize(a);return b.reset(),b.finalize(this._oKey.clone().concat(a))}})}();var N=N||{};N.authors=["aalonsog@dit.upm.es","prodriguez@dit.upm.es","jcervino@dit.upm.es"],N.version=.1;var N=N||{};N.Base64=function(a){"use strict";var b,c,d,e,f,g,h,i,j,k,l,m;for(b=-1,c=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],d=[],g=0;g<c.length;g+=1)d[c[g]]=g;return h=function(a){e=a,f=0},i=function(){var a;return e?f>=e.length?b:(a=255&e.charCodeAt(f),f+=1,a):b},j=function(a){var d,e,f,g;for(h(a),d="",e=new Array(3),f=0,g=!1;!g&&(e[0]=i())!==b;)e[1]=i(),e[2]=i(),d+=c[e[0]>>2],e[1]!==b?(d+=c[e[0]<<4&48|e[1]>>4],e[2]!==b?(d+=c[e[1]<<2&60|e[2]>>6],d+=c[63&e[2]]):(d+=c[e[1]<<2&60],d+="=",g=!0)):(d+=c[e[0]<<4&48],d+="=",d+="=",g=!0),f+=4,f>=76&&(d+="\n",f=0);return d},k=function(){if(!e)return b;for(;;){if(f>=e.length)return b;var a=e.charAt(f);if(f+=1,d[a])return d[a];if("A"===a)return 0}},l=function(a){return a=a.toString(16),1===a.length&&(a="0"+a),a="%"+a,unescape(a)},m=function(a){var c,d,e;for(h(a),c="",d=new Array(4),e=!1;!e&&(d[0]=k())!==b&&(d[1]=k())!==b;)d[2]=k(),d[3]=k(),c+=l(d[0]<<2&255|d[1]>>4),d[2]!==b?(c+=l(d[1]<<4&255|d[2]>>2),d[3]!==b?c+=l(d[2]<<6&255|d[3]):e=!0):e=!0;return c},{encodeBase64:j,decodeBase64:m}}(N);var N=N||{};N.API=function(a){"use strict";var b,c,d,e,f,g,h,j,k,l,m,n,o,p,q,r;return o={service:void 0,key:void 0,url:void 0},r=function(b,c,d){a.API.params.service=b,a.API.params.key=c,a.API.params.url=d},b=function(a,b,c,d,e){d||(d={}),p(function(a){var c=JSON.parse(a);b(c)},c,"POST",{name:a,options:d},"rooms",e)},c=function(a,b,c){p(a,b,"GET",void 0,"rooms",c)},d=function(a,b,c,d){p(b,c,"GET",void 0,"rooms/"+a,d)},e=function(a,b,c,d){p(b,c,"DELETE",void 0,"rooms/"+a,d)},f=function(a,b,c,d,e,f){p(d,e,"POST",void 0,"rooms/"+a+"/tokens",f,b,c)},g=function(a,b,c,d,e){p(c,d,"POST",{name:a,key:b},"services/",e)},h=function(a,b,c){p(a,b,"GET",void 0,"services/",c)},j=function(a,b,c,d){p(b,c,"GET",void 0,"services/"+a,d)},k=function(a,b,c,d){p(b,c,"DELETE",void 0,"services/"+a,d)},l=function(a,b,c,d){p(b,c,"GET",void 0,"rooms/"+a+"/users/",d)},m=function(a,b,c,d,e){p(c,d,"GET",void 0,"rooms/"+a+"/users/"+b,e)},n=function(a,b,c,d,e){p(c,d,"DELETE",void 0,"rooms/"+a+"/users/"+b,e)},p=function(b,c,d,e,f,g,h,i){var j,k,l,m,n,o,p,r;return void 0===g?(j=a.API.params.service,k=a.API.params.key,f=a.API.params.url+f):(j=g.service,k=g.key,f=g.url+f),""===j||""===k?void console.log("ServiceID and Key are required!!"):(l=(new Date).getTime(),m=Math.floor(99999*Math.random()),n=l+","+m,o="MAuth realm=http://marte3.dit.upm.es,mauth_signature_method=HMAC_SHA1",h&&i&&(h=formatString(h),o+=",mauth_username=",o+=h,o+=",mauth_role=",o+=i,n+=","+h+","+i),p=q(n,k),o+=",mauth_serviceid=",o+=j,o+=",mauth_cnonce=",o+=m,o+=",mauth_timestamp=",o+=l,o+=",mauth_signature=",o+=p,r=new XMLHttpRequest,r.onreadystatechange=function(){if(4===r.readyState)switch(r.status){case 100:case 200:case 201:case 202:case 203:case 204:case 205:b(r.responseText);break;case 400:void 0!==c&&c("400 Bad Request");break;case 401:void 0!==c&&c("401 Unauthorized");break;case 403:void 0!==c&&c("403 Forbidden");break;default:void 0!==c&&c(r.status+" Error"+r.responseText)}},r.open(d,f,!0),r.setRequestHeader("Authorization",o),void(void 0!==e?(r.setRequestHeader("Content-Type","application/json"),r.send(JSON.stringify(e))):r.send()))},q=function(b,c){var d,e,f;return d=CryptoJS.HmacSHA1(b,c),e=d.toString(CryptoJS.enc.Hex),f=a.Base64.encodeBase64(e)},formatString=function(a){var b=a.toLowerCase();non_asciis={a:"[àáâãäå]",ae:"æ",c:"ç",e:"[èéêë]",i:"[ìíîï]",n:"ñ",o:"[òóôõö]",oe:"œ",u:"[ùúûűü]",y:"[ýÿ]"};for(i in non_asciis)b=b.replace(new RegExp(non_asciis[i],"g"),i);return b},{params:o,init:r,createRoom:b,getRooms:c,getRoom:d,deleteRoom:e,createToken:f,createService:g,getServices:h,getService:j,deleteService:k,getUsers:l,getUser:m,deleteUser:n}}(N);